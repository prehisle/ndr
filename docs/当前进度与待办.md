# 通用资料管理微服务（NDR）当前进度与待办

> 更新日期：2025-10-19  
> 用途：供团队成员和后续会话快速了解最新状态、风险与下一步计划。

---

## 1. 已完成事项

- **核心功能**：文档、节点、关系的 CRUD 与软删除；节点支持 ltree 路径、子树查询、基本移动。
- **审计与幂等**：写请求强制 `X-User-Id`，审计字段落库；写操作支持 `Idempotency-Key` 最小幂等。
- **可观测性**：结构化日志、Prometheus 指标（低基数标签）、`/health`、`/ready` 检查；就绪检查会验证 Alembic 版本与 `ltree` 扩展。
- **工程基线**：
  - Alembic 迁移（启用 `ltree`）作为唯一建库方式。
  - `pre-commit` 集成 ruff、black、isort、mypy；README 已说明使用方式。
  - GitHub Actions Workflow（`ci.yml`）可在免费 runner 上启动 PostgreSQL 16，自动执行 `pre-commit`、`pytest`。
- **ltree 集成测试**：新增 `tests/test_db_ltree.py`，覆盖子树查询与路径唯一约束，默认使用 fallback 方言以兼容未安装 `_pg_ltree` 的环境。
- **应用服务与仓储**：完成 `DocumentService`/`NodeService`/`RelationshipService` 及对应仓储封装；API 路由统一委派应用层，覆盖子树重写、关系幂等与跨聚合查询（`get_subtree_documents`）的服务单测。
- **应用层守卫**：新增 `BaseService`/`ServiceBundle` 统一事务边界与上下文校验，写操作缺失 `user_id` 将返回 400，避免仓储被直接绕过。
- **恢复接口**：为文档、节点提供 `/restore` API，演示流程见 `tests/demo/test_full_workflow.py`。
- **文档版本历史**：落地 `document_versions` 表及应用服务，支持自动快照、版本列表/详情、差异比对与按版本恢复，对应 API 已覆盖在 `tests/api/test_api_crud.py::test_document_versions_api` 与 demo 测试。

---

## 2. 部分完成 / 进行中

- **架构分层**：守卫逻辑与服务容器已上线，下一步需整理跨用例的事务脚本（如批量写）与回滚策略，并固化在开发指引中。
- **ltree 基准**：`scripts/benchmark_ltree.py` 可输出 GIST/GIN 指标；若环境缺少 `ltree_gin` 运算符类，会提示跳过 GIN，当前仅落地 GIST 结果。
- **测试金字塔**：节点/关系/文档服务单测已覆盖正反用例，后续需引入仓储替身或契约测试，确保缓存/高并发策略及异常场景可重复验证。

---

## 3. 待办事项

1. **慢流水线完善**：在 CI 中增加数据库压测、容器安全、制品扫描等阶段化任务，满足规划要求。
2. **应用层增强**：
   - 将服务层守卫/事务模式沉淀到开发指引，补齐跨服务组合与批量写入的回滚示例。
   - 引入仓储替身或契约测试，覆盖缓存策略、异常分支与高并发场景。
3. **GIN 基准（延后）**：待找到包含 `ltree_gin` 的 PostgreSQL 镜像或安装 `postgresql-16-contrib` 后，再恢复 GIST vs GIN 对比与压测报告。
4. **文档同步**：持续维护本文件和《项目规划与方案》，确保会话上下文始终最新。

---

## 4. 风险与限制

- **GIN 运算符缺失**：大多数官方镜像未预装 `ltree_gin`，脚本会跳过 GIN；若需比较，需换镜像或手工安装扩展。
- **应用层一致性风险**：服务抽象引入后，API 与领域层需保持同步演进；若缺乏统一规范，易出现绕过服务层的实现。
- **预提交首次失败为正常现象**：isort/ruff 会修改文件，必须 `git add` 后再次运行 `pre-commit run --all-files` 直至返回 0。
- **缓存策略外部托管**：NDR 不提供内部缓存或同步机制，若调用方案例缓存失效或脏读，需要上游自建治理与回收流程。

---

## 5. 环境与操作提示

- **预提交**：
  ```bash
  pip install pre-commit
  pre-commit install
  pre-commit run --all-files
  ```
- **数据库基准**：
  ```bash
  .venv/bin/python scripts/benchmark_ltree.py --index gist --index gin --samples 30 --breadth 5 --depth 4
  # 若输出 “Skipped GIN …” 表示当前环境缺少 ltree_gin 运算符类
  ```
- **CI 行为**：默认在 GitHub Actions runner 中启动 PostgreSQL 16（service 容器），脚本会在 job 内执行 `CREATE EXTENSION ltree`。

---

## 6. 快速参考

- 规划方案：见 [docs/项目规划与方案.md](项目规划与方案.md)
- 主要代码目录结构：见 README “目录速览”
- 最近重要提交：
  - `docs: track service layer backlog for node subtree queries`
  - `test: add ltree integration coverage`
  - `style: satisfy linting for tests and benchmark script`
  - `docs: capture session summary in v1019 update`

> 若开启新会话，请同时提供本文件与《项目规划与方案》，即可获取完整上下文。
