# 通用资料管理微服务（NDR）项目规划与方案

> 更新日期：2025-10-19  
> 适用范围：NDR 服务的整体架构、技术决策与迭代规划。  
> 本文用于向新人或新会话快速传达系统目标与实现策略。

---

## 1. 项目概述

- **服务定位**：独立微服务，负责“文档（Document）”、“树形节点（Node）”及二者关系（Node–Document）的全生命周期管理。
- **职责边界**：当前服务不承担缓存职责，所有缓存策略与存储由调用方自管；NDR 专注于节点、文档、节点-文档关联与文档版本的生命周期管理。
- **对外交互**：提供 REST API；上游完成终端用户认证，NDR 仅实现最小化服务鉴权（API Key，可按环境启停）。
- **总体目标**：保持功能交付优先（MVP-first），在不牺牲架构可演进性的前提下，逐步增强安全、可观测性与工程化能力。

---

## 2. 指导原则

1. **简化的六边形/整洁架构**：`api → app → domain → infra`，API 层只做 IO，业务规则沉淀在应用/领域层，仓储接口隔离数据访问。
2. **API 即契约**：所有对外接口位于 `/api/v1`，严格遵循 OpenAPI 规范，同步维护错误体、分页等约定。
3. **PostgreSQL 作为唯一存储**：统一使用 ltree + JSONB，实现树结构与灵活元数据；拒绝 SQLite 等临时后端。
4. **渐进增强**：安全、可观测、工程效率按迭代逐步提升，确保任一阶段都能稳定运行。

---

## 3. 技术架构与目录结构

```
app/
 ├── api/           # FastAPI 路由、DTO、错误映射
 ├── app/           # （规划中）应用服务、用例编排
 ├── domain/        # （规划中）领域模型与仓储接口
 ├── infra/         # 数据库、日志、鉴权、观察性等实现
 └── common/        # 配置、分页、通用错误、日志等
alembic/             # 数据库迁移脚本
scripts/             # 工具脚本（例如 ltree 基准测试）
tests/               # Pytest 测试（API、数据库集成等）
```

---

## 4. 数据建模（PostgreSQL + ltree + JSONB）

| 实体 | 关键字段 | 说明 |
| ---- | -------- | ---- |
| **documents** | `title`、`metadata (JSONB)`、审计字段、软删字段 | 通过 JSONB 支撑可扩展元数据；热点字段可创建 GIN 索引 |
| **nodes** | `name`、`slug`、`path (ltree)`、`parent_id`、`parent_path`、`position`、审计字段、软删字段 | `slug`+父路径构成 `path`；`parent_id` 直接定位父节点；`position` 表示同级顺序；`ltree` 支撑子树查询；同父下 `name` 唯一 |
| **node_documents** | `node_id`、`document_id`、审计字段、软删字段 | 复合主键维护节点-文档绑定关系 |

索引策略：
- `ltree` 默认使用 **GIST** 支撑 `<@/@>` 子树查询；对于特定环境可启用 GIN（需安装 `ltree_gin` 扩展）。
- 部分唯一索引确保软删语义，例如 `WHERE deleted_at IS NULL`。
- `ltree` 路径/父节点冲突在应用层做前置检查，以减少数据库异常。

---

## 5. API 契约与一致性

- **版本管理**：所有接口挂载在 `/api/v1`，预留 `/api/v2` 并行演进能力。
- **请求头**：
  - `X-User-Id`（写操作必需），用于审计字段。
  - `X-Request-Id`（可选），若缺省由服务生成并回传，贯穿日志/响应。
  - `Idempotency-Key`（建议用于写操作）实现最小幂等。
- **节点排序与文档查询**：节点新增 `position` 字段，提供 `POST /api/v1/nodes/reorder` 批量调整同级顺序，返回排序后的节点列表；默认创建会将新节点追加到父节点末尾。文档列表与子树文档接口支持 `metadata.<key>`、`query` 筛选，并允许通过 `include_descendants` 控制子树范围。
- **永久删除控制**：通过独立的 `X-Admin-Key` 头校验 `DESTRUCTIVE_API_KEY`，仅授权调用方可访问 `/api/v1/documents/{id}/purge` 与 `/api/v1/nodes/{id}/purge`，用于在软删后彻底移除资源及关联关系。
- **HTTP Trace 模式**：设置 `TRACE_HTTP=true` 可记录请求/响应正文（默认截断 2KB），用于排查线上重排、永久删除等场景；默认关闭，避免泄露敏感数据。
- **错误响应**：统一输出 RFC 7807 problem+json，包含稳定的 `error_code`（例如 `not_found`、`validation_error`、`conflict`）。
- **分页**：默认 `page=1`、`size=20`，最大 100，后续可扩展游标/键集分页。

---

## 6. 可观测性与安全路线

### 可观测性（MVP）
- 结构化 JSON 日志（输出至 stdout），携带 `request_id`、`user_id`、耗时等字段。
- `/metrics` 暴露 Prometheus 指标（`http_requests_total`、`http_request_duration_seconds` 等，标签使用路由模板避免高基数）。
- `/health`、`/ready`：分别检查存活与数据库/迁移状态（校验 `alembic_version`、`ltree` 扩展、连接池可用性）。

### 安全
- MVP 阶段默认关闭 API Key（内部环境）；通过环境变量启用最小化鉴权。
- 为高危操作配置 `DESTRUCTIVE_API_KEY`，仅持有 `X-Admin-Key` 的调用方可执行永久删除，接口默认返回 503/403 以防误用。
- 通过 `TRACE_HTTP` 控制 HTTP 请求/响应体日志开关，线上默认禁用，排障时临时启用。
- 后续路线：API Key 管理 API → HMAC/防重放/限流 → OAuth2.1 或 mTLS（视场景升级）。
- 敏感配置全部由环境变量注入，不落盘、不回显。

---

## 7. 工程化实践

- **版本控制**：Git，强制在提交前通过 `pre-commit`（ruff、black、isort、mypy）。
- **数据库迁移**：Alembic（`alembic upgrade head`）为唯一建库方式；禁止手工改表。
- **CI 流水线**（`.github/workflows/ci.yml`）：
  1. 启动 PostgreSQL 16 服务，初始化数据库（含 `CREATE EXTENSION ltree`）。
  2. 安装依赖、运行 `pre-commit run --all-files`。
  3. 执行 `pytest`（API + 集成）。
  4. 预留慢流水线扩展（数据库压测、容器安全扫描等）。
- **环境配置**：统一 `.env` 管理 `DB_URL`、`API_KEY` 等；配置校验通过 `app/common/config.py`。

---

## 8. 迭代计划（参考 v4.0）

- **Sprint 1（MVP 功能）**
  - 文档/节点/关系 CRUD + 软删除；
  - ltree 子树查询、简单节点移动；
  - `/health` `/ready` `/metrics`、日志中间件；
  - Alembic 初始化、docker-compose 本地环境、基础测试。

- **Sprint 2（非功能增强）**
  - API Key 鉴权（可配置启停）、错误体 `error_code`；
  - 节点移动乐观锁（ETag/If-Match）、分页游标选项；
  - 指标扩展、（可选）链路追踪；覆盖率提升 ≥80%。

- **Sprint 3（产品化与性能）**
  - 文档版本历史/回滚（已实现：快照、差异比对与按版本恢复）；
  - PostgreSQL 全文检索、Redis 限流；
  - 并发控制优化（advisory lock）、压测与优化报告。

---

## 9. 性能与基准策略

- `scripts/benchmark_ltree.py` 支持生成模拟树形数据，比较 GIST / GIN 索引的查询延时与执行计划。
- 环境缺少 GIN 时脚本会自动跳过并输出提示；未来可换用带 `ltree_gin` 的镜像重新跑基准。
- 建议在 CI 慢流水线或性能环境中定期跑基准，记录 GIST 作为基线，并持续关注 GIN 的可用性。

---

## 10. 风险与应对

| 风险 | 描述 | 应对策略 |
| ---- | ---- | -------- |
| 树结构频繁变更 | 节点移动、大规模调整可能导致写放大、死锁 | 事务内批量更新子树，并使用 `pg_advisory_lock` 控制并发顺序 |
| 指标高基数 | 指标标签携带动态 ID | 统一使用路由模板标签；日志保留 request/user 信息 |
| JSONB 膨胀 | 元数据字段过多、查询慢 | 区分冷热字段、必要时加表达式索引或拆分字段 |
| 工程质量下滑 | 直接在路由层编写业务逻辑，难以复用 | 规划 `NodeService get_subtree_documents` 等应用服务，逐步迁移到领域层并补齐单元测试 |

---

## 11. 操作说明（快速上手）

```bash
# 1. 安装依赖
pip install -r requirements.txt
pip install pre-commit
pre-commit install

# 2. 准备数据库（需 PostgreSQL 16+）
alembic upgrade head  # 启用 ltree、建表

# 3. 运行服务
uvicorn app.main:app --reload

# 4. 运行测试 / 预提交
pre-commit run --all-files
pytest
```

---

## 12. 文档索引

- **当前进度与待办**：详见 [docs/当前进度与待办.md](当前进度与待办.md)。
- **ltree 基准脚本**：`scripts/benchmark_ltree.py`（脚本内含使用说明）。
- **数据库迁移脚本**：`alembic/versions/*`。

> 如需在新会话中使用，请同时附上本文件与《当前进度与待办》文档，以便快速建立上下文。
