# 通用资料管理微服务（NDR）状态看板

> 更新日期：2025-10-26  
> 用途：集中追踪当前进展、里程碑状态、待办与风险，供团队成员与 AI Agent 快速同步上下文。

---

## 1. 最新进展

- **核心功能**：完成文档、节点、关系 CRUD 与软删除；节点支持 ltree 路径、子树查询与节点移动。
- **审计与幂等**：写请求强制 `X-User-Id`，配合 `Idempotency-Key` 提供最小幂等保障。
- **可观测性**：结构化日志、Prometheus 指标、`/health`、`/ready` 自检；就绪检查覆盖 Alembic 版本与 `ltree` 扩展。
- **工程基线**：Alembic 迁移作为唯一建库方式；`pre-commit` 集成 ruff/black/isort/mypy；GitHub Actions 启动 PostgreSQL 16 并执行 `pre-commit`、`pytest`。
- **应用服务与仓储**：`DocumentService`、`NodeService`、`RelationshipService` 及相关仓储抽象落地；API 路由统一委派服务层，覆盖子树重写、关系幂等与跨聚合查询测试。
- **接口增强**：文档/子树接口支持 `metadata.*`、`query` 筛选与 `include_descendants` 选项；新增 `/api/v1/documents/reorder` 提供仅排序而不生成新版本的能力；节点提供 `/reorder` 排序与 `/purge` 永久删除（需 `X-Admin-Key`）。
- **文档版本历史**：实现快照、版本列表、差异比对与按版本恢复，相关 API 已覆盖在集成测试与 demo 场景。
- **TRACE_HTTP 脱敏**：日志自动掩码常见敏感字段；`scripts/cleanup_idempotency.py` 提供幂等记录清理脚本并附文档说明。

---

## 2. 里程碑进展

### M1：正确性与稳定性（已完成）
- 节点 slug 全链路校验，禁止非 `[a-z0-9_]` 或带点字符。
- `NodeService` 兜底校验，确保绕过 API 的调用返回一致错误。
- `node_documents(document_id)` 索引加速文档关联查询。
- 补充 slug 校验用例与异常映射一致性测试。
- 验收：`pytest` 全量通过，`/ready` 自检覆盖迁移与扩展。

### M2：运维与可观测性优化（已完成）
- 幂等记录清理脚本与调度示例。
- TRACE_HTTP 日志脱敏逻辑上线并具备最小单测。
- 验收：脚本与文档发布，维护指南同步说明。

### M3：CI 与质量门禁（进行中）
- CI 引入 `pip-audit`／`safety`（非阻塞）。
- 覆盖率阈值 ≥85% 已在 CI 中生效。
- mypy 基线配置上线，后续将按模块提升严格度。
- 剩余：细化 mypy 收敛路线并在文档记录推进节奏。

### M4：运营与管理能力（规划中）
- 目标：提供管理端点（幂等清理、索引重建、自检报告导出）与批量接口，均需 `X-Admin-Key` 控制。
- 状态：尚未启动，待完成前序质量门槛后排期。

---

## 3. 待办事项

1. **CI 慢流水线完善**：补充数据库压测、容器安全与制品扫描阶段，形成分层质量门槛。
2. **应用层增强**：沉淀跨服务事务模式与回滚示例，维护开发指引；引入仓储替身或契约测试覆盖缓存/高并发场景。
3. **GIN 基准（延后）**：准备包含 `ltree_gin` 的 PostgreSQL 环境，恢复 GIST vs GIN 对比与压测报告。
4. **文档同步流程**：明确各文档维护责任人与更新节奏，保持状态看板与规划文档一致。
5. **mypy 规则收敛**：制定分模块升级计划（如 `disallow_untyped_defs`），并在升级后更新维护指南与状态看板。

---

## 4. 风险与限制

- **GIN 运算符缺失**：官方镜像缺省不含 `ltree_gin`，基准脚本会跳过；需自建或更换镜像后再比较 GIST/GN。
- **应用层一致性风险**：服务抽象上线后，若缺乏统一规范易被绕过；需及时更新开发指引并补充回归测试。
- **预提交初次失败**：isort/ruff 会直接改动文件；需 `git add` 后再运行以确保通过。
- **缓存策略外部托管**：NDR 不处理缓存或无效化，调用方需自建治理流程以避免脏读。

---

## 5. 快速参考

- **预提交**：
  ```bash
  pip install pre-commit
  pre-commit install
  pre-commit run --all-files
  ```
- **数据库基准**：
  ```bash
  .venv/bin/python scripts/benchmark_ltree.py --index gist --index gin --samples 30 --breadth 5 --depth 4
  # 若输出 “Skipped GIN …” 表示缺少 ltree_gin 运算符类
  ```
- **CI 行为**：GitHub Actions 启动 PostgreSQL 16，自动执行 `CREATE EXTENSION ltree`，随后运行 `pre-commit` 与 `pytest`。
- **开发/维护提示**：开启新会话或交接时，请同步本状态看板与《项目规划与方案》，确保上下文一致。

### Metadata 过滤语法速查

| 写法 | 说明 | 示例 |
| --- | --- | --- |
| `metadata.field=value` | 等值匹配；重复同名参数视为 OR | `metadata.stage=draft&metadata.stage=final` |
| `metadata.field[in]=a,b` | IN 匹配，可用逗号或重复参数 | `metadata.stage[in]=draft,final` |
| `metadata.field[like]=foo` | 模糊匹配；缺省添加 `%` 前后缀 | `metadata.title[like]=设计` |
| `metadata.field[gt] / [gte] / [lt] / [lte]` | 数值范围比较，仅接受单个数字 | `metadata.score[gt]=90` |
| `metadata.field[any]=x` | JSON 数组/对象包含任一值 | `metadata.tags[any]=alpha` |
| `metadata.field[all]=x` | JSON 数组需同时包含所有值 | `metadata.tags[all]=alpha&metadata.tags[all]=beta` |

> 错误运算符或非法数值会立即返回 400，便于调用方尽早发现问题。
