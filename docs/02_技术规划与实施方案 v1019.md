# 技术规划与实施方案 v1019（会话同步稿）

> 本稿记录 2025-10-19 会话中形成的决策、现状整理与后续任务，供后续会话作为上下文继续推进。

## 1. 核心结论

- **ltree/GIST 作为当前基线**：由于常用镜像缺少 `ltree_gin` 运算符类，GIN 基准测试暂缓，`scripts/benchmark_ltree.py` 会在缺失时自动跳过 GIN，仅输出 GIST 指标。[docs/03_当前状态.md](docs/03_%E5%BD%93%E5%89%8D%E7%8A%B6%E6%80%81.md) 已同步记录。
- **ltree 集成测试已补齐**：新增 `tests/test_db_ltree.py` 覆盖子树查询与路径唯一性；测试默认使用 fallback 方言，保证在无 `_pg_ltree` 的环境下仍可运行。
- **CI/预提交工具链上线**：`pre-commit` 提供 ruff、black、isort、mypy；GitHub Actions Workflow（`.github/workflows/ci.yml`）可在免费 runners 上启动 PostgreSQL 16，执行 `alembic upgrade head`、pre-commit、pytest。使用者需本地 `pip install pre-commit` 后再运行 `pre-commit run --all-files`。
- **服务层待办明确**：节点/关系查询仍散落在路由层。待抽象 `NodeService.get_subtree_documents` 等应用/领域服务，配合领域单测支撑“节点 + 子树文档”能力。

## 2. 执行现状快照

- **代码结构**：
  - FastAPI 路由仍直接操作 SQLAlchemy Session；
  - `app/infra/db/types.py` 保留 `_pg_ltree` 与 fallback 实现；
  - `scripts/benchmark_ltree.py` 使用 `DeclarativeBase`。
- **测试总览**：
  - API 集成测试（`tests/test_api_crud.py` 等）；
  - 数据库层 ltree 集成测试（`tests/test_db_ltree.py`）；
  - 预提交钩子必须全部通过后再推送。
- **文档同步**：
  - `docs/03_当前状态.md` 持续更新，记录 GIN 推迟与服务层待办；
  - README 提供 benchmark 用法、预提交、CI 说明。

## 3. 已知限制与风险

1. **GIN 支持缺失**：官方 Debian/Ubuntu 镜像未必预装 `ltree_gin`；如需 GIN 基准，需换成带 contrib 的镜像（例 `postgres:16-bookworm`）或手动安装 `postgresql-16-contrib`，否则只能使用 GIST。
2. **结构化服务缺口**：节点子树 + 文档关系属于高频需求，但当前缺少应用/领域层封装，容易导致路由膨胀、测试困难。
3. **预提交首跑失败属正常**：isort/ruff 等会修改文件，需 `git add` 后再次运行，确保 CI 成功。

## 4. 下一步优先级建议

1. **完成慢流水线/压测脚本整合**：在 GitHub Actions 新增压测、安全扫描等阶段化任务，满足 v4.0 规划要求。
2. **设计并实现 NodeService**：
   - 封装节点子树查询、批量取文档关系；
   - 提供面向 `ltree` 的仓储接口及领域层单测；
   - 考虑分页/限制策略以避免一次返回过多数据。
3. **恢复 GIN 基准（条件成熟时）**：
   - 准备带 `ltree_gin` 的数据库镜像；
   - 补充 GIST vs GIN 指标记录，沉淀调优建议。

## 5. 操作备忘

- 激活虚拟环境后运行：
  ```bash
  pip install -r requirements.txt
  pip install pre-commit
  pre-commit install
  pre-commit run --all-files
  pytest
  ```
- 本地 `git push` 必须在所有预提交钩子与测试通过后执行；CI 失败常见原因是忘记包含 isort/ruff 自动修改的文件。
- `scripts/benchmark_ltree.py` 示例：
  ```bash
  .venv/bin/python scripts/benchmark_ltree.py --index gist --index gin --samples 30 --breadth 5 --depth 4
  ```
  若环境缺少 GIN 运算符类，脚本会提示 “Skipped GIN …” 并继续输出 GIST 数据。

---

> 后续新会话请先携带本文件、`docs/03_当前状态.md` 以及最新 commit 日志作为上下文，以便 AI 快速接手。
