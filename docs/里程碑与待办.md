# NDR 里程碑与待办

> 最近更新时间：2025-10-26

---

## 里程碑 M1：正确性与稳定性（已完成）

- 节点 slug 校验：限制为 `[a-z0-9_]`，长度 1-255，禁止 `.`，避免 ltree 解析错误。
- 服务层兜底：在 `NodeService` 中再次校验，确保绕过 API 校验的调用也能得到一致错误。
- 关系查询索引：为 `node_documents(document_id)` 增加索引，优化按文档查关系与子树文档分页。
- 测试覆盖：新增 API 层校验用例，确保无效 slug 返回 422；更新路由异常映射（400/422）一致性。

验收标准：`pytest` 全量通过；本地与 CI 均可运行迁移并通过自检（/ready）。已满足。

---

## 里程碑 M2：运维与可观测性优化（进行中）

- 幂等记录清理脚本：按 `expires_at` 清理 `idempotency_records`，提供运行指引与计划任务示例。（已落地 `scripts/cleanup_idempotency.py`）
- TRACE_HTTP 脱敏：日志中对常见敏感字段（如 `password`、`token`、`secret`）进行掩码处理。（已落地，中间件自动启用）

验收标准：新增脚本与文档；在维护指南中给出示例 crontab；新增最小单测覆盖脱敏逻辑。（已完成）

---

## 里程碑 M3：CI 与质量门禁（进行中）

- 增加 `pip-audit/safety` 到 CI（已加入，非阻塞）。
- 增加覆盖率统计与阈值（85%）（已加入并通过）。
- 收敛 mypy 规则，逐步提升严格度（disallow_untyped_defs 等）。

验收标准：CI 工作流包含新阶段并稳定通过；README/维护指南同步更新。（部分完成）
备注：已加入 mypy 基线配置（mypy.ini），CI 中 mypy 步骤为非阻塞，后续分模块逐步提高严格度。

---

## 里程碑 M4：运营/管理能力（可选）

- 管理端点：幂等清理、索引重建、自检报告导出（需 `X-Admin-Key`）。
- 批量接口：批量创建文档、批量绑定/解绑关系，并与 Idempotency-Key 组合使用。

验收标准：端点具备权限校验与审计日志；提供 OpenAPI 文档与最小用例。

---

## 当前待办

- [x] API 模型增加 slug 校验（NodeCreate/NodeUpdate）。
- [x] `NodeService` 增加 slug 兜底校验；路由捕获 `InvalidNodeOperationError` → 400。
- [x] 新增 `tests/api/test_nodes_validation.py` 覆盖无效 slug（创建与更新）。
- [x] Alembic 迁移：`ix_node_documents_document_id` 索引。
- [x] 更新 README 与维护指南的限制说明（slug 与新索引）。
- [x] TRACE_HTTP 请求/响应脱敏并补充测试。
- [x] 清理脚本：`scripts/cleanup_idempotency.py` 与文档。
- [x] CI 覆盖率门槛（85%）与依赖安全扫描。
- [ ] mypy 规则收敛方案（拆分模块逐步启用更严格规则）。
