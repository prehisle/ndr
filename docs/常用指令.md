# 常用指令与排错提示

## 环境配置
- 本地开发默认从 `.env.development` 读取配置；部署环境请通过环境变量注入，示例见 `.env.example`。
- 永久删除相关接口需要配置 `DESTRUCTIVE_API_KEY`，例如：
  ```bash
  export DESTRUCTIVE_API_KEY=admin-secret
  ```

## 永久删除接口调用
- 在执行 `/api/v1/documents/{id}/purge` 或 `/api/v1/nodes/{id}/purge` 前，务必先完成软删除。
- 请求头需同时携带：
  - `X-User-Id: <操作者标识>`
  - `X-Admin-Key: <与 DESTRUCTIVE_API_KEY 相同的值>`
- 未携带或密钥不匹配会返回 403，并在日志中输出类似 `admin_key_mismatch admin_key_preview=xxxx***` 的告警，可据此前缀定位调用来源。

## 日志排查
- 常见格式：
  ```
  WARNI [http] http_exception status=404 detail=Node not found method=GET path=/api/v1/nodes/1 ...
  WARNI [http] admin_key_mismatch admin_key_preview=abcd***
  ```
- 404 表示资源已不存在（如已 purge）；若为误删，可通过恢复接口或回滚数据。
- `admin_key_mismatch` 表示未传或传错 `X-Admin-Key`；确认服务端环境变量及请求头是否一致。

## 测试运行
- 运行前安装依赖：
  ```bash
  pip install -r requirements.txt
  ```
- 执行单个测试（示例）：
  ```bash
  python -m pytest tests/api/test_api_crud.py::test_permanent_delete_requires_admin_key
  ```
- 测试会自动注入 `DESTRUCTIVE_API_KEY=admin-secret`，并执行 Alembic 迁移。
