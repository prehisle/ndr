# 通用资料管理微服务（DMS）技术规划与实施方案 v4.0

版本：v4.0（2025-10-17）
作者：项目组
状态：MVP-first（功能可交付优先；非功能渐进增强）

- 面向目标：实用性、可维护性、可扩展性；先交付可用功能，非功能按迭代增强
- 架构风格：简化六边形/整洁架构（API 即契约，数据以 PostgreSQL 为骨干）
- 安全优先级：内部服务，安全需求优先级低；生产环境通过网关/TLS 统一治理

---

## 1. 综述与范围

- 服务定位：独立微服务，负责通用资料（Document）、组织节点（Node/树形）、两者关系（Node–Document）管理。
- 外部交互：REST API；上游系统负责终端用户认证，本服务聚焦服务间最简鉴权（MVP 可关闭）。
- 非功能性策略："能用优先"，可观测/安全/治理逐步增强，不反噬架构。

---

## 2. v4.0 相比 v3.0 的关键改动（整合与取舍）

- 指标标签低基数化：Prometheus 指标使用“路由模板”作为标签（如 /api/v1/nodes/{id}），避免动态 ID 造成高基数；user_id/request_id 仅出现在结构化日志，不进入指标标签。
- ltree 索引选择与验证：默认使用 GIST 支撑子树查询（<@/@>）；对高频相等/前缀匹配场景，保留切换/联用 GIN 的选项；在集成测试阶段进行基准比对后定型。
- 路径唯一性与命名：新增 slug（用于路径 label）与 name（展示用）两个字段；以 slug 构建 ltree path；增加 path 的部分唯一索引（WHERE deleted_at IS NULL）与“同父下 name 唯一”索引。
- 节点移动并发控制：移动节点采用事务 + 子树批量更新；建议引入 pg_advisory_lock（按节点 ID）或明确锁顺序（先父后子）避免死锁。
- 幂等性最小实现（MVP 启用）：写操作支持 Idempotency-Key；引入轻量幂等存储（key、request_hash、status、response_snippet、expires_at），TTL 可配置（如 24h）。
- 乐观锁（可选，Sprint 2）：资源支持 version/ETag + If-Match，减少并发写覆盖风险。
- 就绪检查增强：/ready 检查数据库连接、迁移状态（alembic_version == head）、连接池可用性；启动初期容错。
- 分页策略：默认 page/size；为大数据量保留“游标（键集分页）”选项（后续迭代）。
- 安全优先级调整：MVP 默认不启用鉴权（API_KEY_ENABLED=false）；生产通过网关统一 TLS/限流；HMAC/防重放/限流迁至后续迭代。

---

## 3. MVP 范围（Sprint 1，约 1 周）

业务能力（可交付）
- Document：创建/查询/更新/软删除；metadata 使用 JSONB。
- Node：创建/查询/更新/软删除；path 使用 ltree，支持子树查询与简单移动（事务保护）。
- Node–Document：绑定/解绑关系；按节点或文档列出绑定。

API（/api/v1）
- Documents：POST、GET /{id}、PUT/PATCH /{id}、DELETE（软删）、GET（分页/过滤）。
- Nodes：POST、GET /{id}、PUT/PATCH /{id}、DELETE（软删）、GET、GET /{id}/children?depth=n。
- Relationships：POST（bind）、DELETE（unbind）、GET?node_id= 或 GET?document_id=。

一致性与审计
- 软删除默认排除（提供 include_deleted）；部分唯一索引保证语义。
- 审计：使用 X-User-Id 注入操作者，落库 created_by/updated_by；日志记录 request_id/user_id。
- 幂等：POST/PUT 支持 Idempotency-Key（最小实现）。

可观测性（MVP 基础）
- 结构化 JSON 日志（stdout），包含 request_id、user_id、path、status、latency_ms。
- 指标：http_requests_total、http_request_duration_seconds（路由模板标签）；/metrics 暴露。
- 健康/就绪：/health（存活）、/ready（DB 与迁移状态）。

工程化基线
- Alembic 初始化与迁移（启用 ltree）。
- 代码规范：ruff/black/isort/mypy；pre-commit。
- 测试：pytest（初始覆盖率目标≥60%，后续提升）；API 集成测试覆盖主要路径。
- 容器与启动：多阶段构建、非 root（开发态可关闭只读根文件系统）；docker-compose 一键起服务与数据库。

---

## 4. 分层架构与目录

- api：FastAPI 路由/DTO/请求校验与错误映射。
- app：应用协调层，用例编排与事务边界。
- domain：领域模型与服务；仓储接口定义。
- infra：持久化实现（SQLAlchemy ORM/会话/迁移）、可观测性、（可选）鉴权占位。
- common：配置、日志、分页与通用错误。

目录示例（略）

---

## 5. 数据建模（PostgreSQL + ltree + JSONB + 软删除）

- 启用扩展：CREATE EXTENSION IF NOT EXISTS ltree;
- documents：title、metadata（JSONB）、审计与时间戳、deleted_at；GIN 索引按热点键增设。
- nodes：name、slug、path（ltree）、审计字段、时间戳、deleted_at；
  - 索引：GIST(path)；部分唯一索引：path（WHERE deleted_at IS NULL）；同父下 name 唯一；必要表达式索引（如 metadata->>'type'）。
- node_documents：复合主键（node_id, document_id），软删与审计字段。

---

## 6. API 契约与一致性

- 版本：/api/v1（预留 /api/v2 并行演进）。
- 头部：X-User-Id（写必需）、X-Request-Id（可选，若缺省服务生成并回传）、Idempotency-Key（写建议）。
- 分页：page（默认1）、size（默认20，最大100）。
- 错误体：RFC 7807；增加稳定的 error_code 便于上游处理（如 validation/not_found/conflict）。
- OpenAPI：自动生成并补充示例与错误样例；标注 deprecated 策略。

---

## 7. 安全路线（优先级下调，渐进增强）

- MVP：默认关闭 API Key；内部网络/网关统一 TLS 与基本限流；敏感信息不入仓库。
- Sprint 2：完善 API Key 模型与校验（仅哈希存储，常量时间比较）；管理 API（create/list/disable/enable/rotate）。
- Sprint 3（可选）：写操作 HMAC 签名与时间窗、防重放 nonce（Redis）、限流（按 key/route/tenant）。
- 中长期（可选）：OAuth2.1 Client Credentials 或 mTLS；必要时引入多租户（tenant_id + RLS）。

---

## 8. 可观测性（零外部依赖起步，可插拔增强）

- 基础版：结构化日志 + /metrics + /health + /ready；指标仅使用低基数标签（路由模板）。
- 增强版（后续）：接入 Prometheus/Tempo/Jaeger/Loki；OpenTelemetry 可开关，默认 no-op。

---

## 9. TDD 与测试金字塔

- 单元测试（Domain/Service）为主，Mock 仓储；覆盖软删除、审计落库、ltree 规则。
- API 集成测试（API 层）：FastAPI TestClient 验证请求校验、错误体、分页、上下文。
- DB 集成测试（Infra/Repository）：迁移后验证 ltree 子树查询与索引效果（可在 Sprint 2 完成）。
- 覆盖率门槛：初始≥60%，Sprint 2 提升至≥80%，核心服务≥90%。

---

## 10. CI/CD 与运行

- 快速流水线：Lint/Type/Unit/API 测试（尽量快）。
- 集成阶段（后续）：启动 PostgreSQL，执行迁移，运行集成测试；缓存 pip 与 Docker 层。
- 构建与发布：多阶段 Docker 构建，非 root；部署前自动执行 Alembic 迁移与冒烟测试。

---

## 11. 迭代计划（MVP-first）

Sprint 1（功能交付，约 1 周）
- 核心 CRUD（Document/Node/Relationship）+ 软删除 + ltree 子树查询
- 审计（X-User-Id）与最小幂等（Idempotency-Key）
- /health、/ready、/metrics 与日志中间件（低基数标签）
- Alembic 初始化与迁移（ltree）；docker-compose 启动；基础测试与质量门槛（≥60%）

Sprint 2（非功能增强，约 1 周）
- API Key 模型与校验中间件（可配置启用）；错误体标准化（error_code）
- 乐观锁（ETag/If-Match）、就绪检查增强、分页游标选项
- 指标完善与（可选）tracing；覆盖率提升至≥80%/核心≥90%

Sprint 3（产品化与性能，1-1.5 周）
- 文档版本历史与回滚 API（全量快照起步）
- PostgreSQL 全文检索与索引优化；限流（Redis 令牌桶）
- 并发控制优化（advisory lock）、压测与优化报告

---

## 12. 风险与应对

- 树结构频繁变更：使用 ltree；移动以事务批量更新子树 path；引入并发锁避免死锁。
- 路径冲突与数据一致性：部分唯一索引（path/name-under-parent）；迁移与回滚演练。
- 指标高基数风险：采用路由模板标签；监控基数与资源占用。
- JSONB 膨胀：区分冷热字段，必要表达式索引；Pydantic v2 校验 JSON Schema。

---

## 13. 变更日志

v4.0（当前）
- 指标标签低基数化；ltree 索引选择策略与基准验证
- 路径唯一与 slug/name 分离；节点移动并发控制建议
- 启用最小幂等；就绪检查增强；安全优先级下调（MVP 默认关闭鉴权）
- 测试覆盖率门槛阶段性提升；迭代计划以功能交付为先

v3.0（上一版）
- 六边形架构与数据建模（ltree/JSONB/软删除）
- 安全渐进路线与可观测性零依赖方案；全面工程治理与 CI/CD

---

## 14. 结论

v4.0 方案在保持架构与数据模型稳健的同时，明确“功能交付优先、非功能渐进增强”的路径，契合内部服务安全优先级低的现实场景。通过对指标、ltree、幂等、并发控制、就绪检查等落地细节的优化，确保 MVP 快速交付并可在后续迭代平滑增强而不反噬架构。