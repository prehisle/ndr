# 通用资料管理微服务（DMS）技术规划与实施方案 v3.0

版本：v3.0（2025-10-17）
作者：项目组
状态：可执行蓝图（MVP → 渐进增强）

- 面向目标：实用性、可维护性、可扩展性优先，以敏捷迭代持续演进
- 架构风格：简化的六边形/整洁架构，API 即契约，数据以 PostgreSQL 为骨干
- 研发方法：TDD 驱动、测试金字塔、CI/CD 全流程治理

---

## 1. 综述与范围

- 服务定位：独立微服务，负责通用资料（Document）、组织节点（Node/树形）、两者关系（Node–Document）管理。
- 外部交互：通过 REST API 提供服务；上游系统负责终端用户认证，本服务聚焦服务间鉴权与授权。
- 非功能性目标：安全（渐进增强）、可靠、可观测、可演进、低耦合、高内聚。

v3.0 相比 v2.0 的核心改进
- 树结构：优先采用 PostgreSQL `ltree` 扩展，替代 MPTT，降低变更成本，提升查询与移动能力。
- 安全：从最简 API Key 起步，规划 HMAC 签名、防重放、限流与密钥轮换，预留中长期 OAuth2/mTLS。
- 可观测性：MVP 即零外部依赖（结构化日志 + /metrics + 健康/就绪）；后续可插拔接入 Prometheus/Tempo/Jaeger/Loki。
- 工程化：TDD 全覆盖、pre-commit、类型检查、CI 流水线、容器安全、数据库迁移治理。

---

## 2. 指导原则

- 单一职责与清晰边界：API 层只做 IO，业务在 Service 层，数据访问在 Repository 层。
- API 即契约：`/api/v1` 版本化，向后兼容；OpenAPI 文档自生成 + 示例完善。
- 可演进数据模型：关系型骨干 + JSONB 扩展；关键 JSONB 键建立索引；软删除 + 部分唯一索引。
- 可观测性与安全先行但渐进：MVP 具备基础观测与最简鉴权，迭代增强不破坏架构。
- 测试左移：TDD 驱动，单元优先、集成必要，保障覆盖率与质量门槛。
- 12-Factor：配置外置、无状态服务、环境隔离、日志输出到标准输出。

---

## 3. MVP 范围（Sprint 1，1-1.5 周）

业务闭环能力
- Document：创建/查询/更新/软删除；metadata 使用 JSONB。
- Node：创建/查询/更新/软删除；`path` 使用 `ltree`，支持子树查询与简单移动。
- Node–Document：绑定/解绑关系；按节点或文档列出关系。

API（`/api/v1`）
- Documents：`POST`、`GET /{id}`、`PUT/PATCH /{id}`、`DELETE /{id}`（软删）、`GET`（分页/过滤）。
- Nodes：`POST`、`GET /{id}`、`PUT/PATCH /{id}`、`DELETE /{id}`（软删）、`GET`、`GET /{id}/children?depth=n`。
- Relationships：`POST`（bind）、`DELETE`（unbind）、`GET?node_id=`/`GET?document_id=`。

审计与上下文
- 使用请求头 `X-User-Id` 注入操作者；落库到 `created_by`/`updated_by`；日志记录 `request_id` 与 `user_id`。

查询一致性与软删除
- 默认排除 `deleted_at IS NOT NULL` 的记录；提供 `include_deleted` 开关。
- 唯一约束使用 Partial Index：`WHERE deleted_at IS NULL`。

可观测性基础
- 结构化 JSON 日志（标准输出）。
- `GET /metrics`（Prometheus 指标，Counter/Histogram）。
- `GET /health`（存活）、`GET /ready`（依赖可用，例如 DB）。

工程化基线
- Alembic 初始化与迁移管理；启用 `ltree` 扩展。
- 代码规范：`ruff`/`black`/`isort`/`mypy`；`pre-commit`。
- 测试：`pytest` + 覆盖率门槛；API 集成测试使用 `TestClient`。
- 容器：多阶段构建、非 root、只读文件系统（可配置）。
- 启动：`docker-compose` 一键起服务与数据库。

---

## 4. 分层架构与目录

分层设计（简化六边形）
- `api`：FastAPI 路由/DTO/请求校验与错误映射。
- `app`：应用协调层，用例编排与事务边界（可与 `domain/services`合并）。
- `domain`：领域模型与服务（规则、策略、用例）；仓储接口定义。
- `infra`：持久化实现（SQLAlchemy ORM/会话/迁移）、可观测性、鉴权。
- `common`：配置、日志、分页与通用错误。

目录示例
- `app/`
  - `api/v1/routers/documents.py|nodes.py|relationships.py`
  - `api/v1/deps.py`（依赖注入：DB、上下文）
  - `domain/models/`（Pydantic schemas + 领域对象）
  - `domain/services/`（`DocumentService`/`NodeService`/`RelationshipService`）
  - `domain/repositories/`（接口定义）
  - `infra/db/`（`base.py`、`models.py`、`repositories.py`、`migrations/`）
  - `infra/observability/`（指标/追踪中间件）
  - `infra/security/`（API Key 校验占位）
  - `common/`（`config.py`/`logging.py`/`pagination.py`）
  - `main.py`

---

## 5. 数据建模（PostgreSQL + ltree + JSONB + 软删除）

启用扩展
```sql
CREATE EXTENSION IF NOT EXISTS ltree;
```

核心表（摘要）
```sql
-- documents
CREATE TABLE documents (
  id           BIGSERIAL PRIMARY KEY,
  title        TEXT NOT NULL,
  metadata     JSONB NOT NULL DEFAULT '{}',
  created_by   TEXT NOT NULL,
  updated_by   TEXT NOT NULL,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at   TIMESTAMPTZ NULL
);
CREATE INDEX idx_documents_metadata_gin ON documents USING GIN (metadata);

-- nodes（ltree 路径）
CREATE TABLE nodes (
  id           BIGSERIAL PRIMARY KEY,
  name         TEXT NOT NULL,
  path         LTREE NOT NULL,
  created_by   TEXT NOT NULL,
  updated_by   TEXT NOT NULL,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at   TIMESTAMPTZ NULL
);
CREATE INDEX idx_nodes_path_gist ON nodes USING GIST (path);

-- node-document relationships
CREATE TABLE node_documents (
  node_id      BIGINT NOT NULL REFERENCES nodes(id),
  document_id  BIGINT NOT NULL REFERENCES documents(id),
  created_by   TEXT NOT NULL,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at   TIMESTAMPTZ NULL,
  PRIMARY KEY (node_id, document_id)
);
```

约束与索引
- 软删除下的唯一性：为需要唯一的列建立部分唯一索引，例如：
```sql
CREATE UNIQUE INDEX uniq_node_name_under_parent ON nodes(name, subpath(path, 0, nlevel(path)-1))
WHERE deleted_at IS NULL;
```
- JSONB 热键建立 GIN 索引（必要时使用 `jsonb_path_ops`）。
- ltree 路径索引：GIST；移动节点使用事务并考虑并发锁（如 `FOR UPDATE`）。

---

## 6. API 契约与一致性

统一约定
- 版本：`/api/v1`，预留 `/api/v2` 并行演进策略。
- 头部：
  - `X-User-Id`：写操作必需；读操作可选，用于审计。
  - `X-Request-Id`：可选；若缺省由服务生成并回传。
- 分页：`page`（默认 1）、`size`（默认 20，最大 100）。
- 过滤/排序：统一参数命名与语义；软删除通过 `include_deleted` 控制。
- 幂等性：建议写操作支持 `Idempotency-Key`（MVP 可先设计保留位）。
- 错误体：RFC 7807（`type`、`title`、`status`、`detail`、`instance`）。
- OpenAPI：自动生成并补充示例/错误样例/鉴权说明；维护变更日志与弃用策略。

示例：创建文档
```http
POST /api/v1/documents
Headers:
  Content-Type: application/json
  X-User-Id: user-123

Body:
{
  "title": "Spec A",
  "metadata": {"type": "spec", "tags": ["a", "b"]}
}

201 OK
{
  "id": 1,
  "title": "Spec A",
  "metadata": {"type": "spec", "tags": ["a", "b"]},
  "created_by": "user-123",
  "created_at": "2025-10-17T03:00:00Z"
}
```

子树查询（ltree）
```http
GET /api/v1/nodes/{id}/children?depth=2
```
实现要点：使用 `path <@ base_path` 与 `nlevel()` 控制层级。

---

## 7. 安全路线（渐进增强）

阶段目标
- MVP（开发态）：可配置启用最简 API Key（静态白名单），或在非生产环境关闭鉴权以提升迭代速度。
- Sprint 2：完善 API Key 模型与校验中间件；管理 API（创建/启用/禁用/轮换）。
- Sprint 3：写操作引入 HMAC 签名与时间窗；防重放 nonce（Redis 短存）；按 Key/租户限流。
- 中长期：可选引入 OAuth2.1 Client Credentials 或 mTLS；按需要做多租户隔离（`tenant_id` + RLS）。

API Key 模型建议字段
- `id`、`key_hash`（只存哈希）、`owner`（上游系统/客户端）、`status`、`expires_at`、`scopes`、`rate_limit`、`ip_whitelist`、`last_used_at`。

签名与防重放（写操作）
- 头部：`X-API-Key`、`X-Timestamp`、`X-Signature`（HMAC-SHA256(body + path + ts)）。
- 有效期：如 5 分钟时间窗；`nonce` 去重（Redis TTL）。

传输安全
- 强制 HTTPS/TLS；生产环境通过网关统一校验与限流；密钥通过 Vault/KMS 管理，不以明文环境变量分发。

---

## 8. 可观测性（零依赖起步，可插拔增强）

基础版（MVP 即启）
- 日志：结构化 JSON 到标准输出；包含 `request_id`、`user_id`、`path`、`method`、`status`、`latency_ms`；敏感字段脱敏。
- 指标：`/metrics` 暴露 Prometheus 指标（`http_requests_total`、`http_request_duration_seconds`、DB 连接池）。
- 健康/就绪：`/health`、`/ready`；`/ready` 检查数据库连接与迁移状态。
- 追踪：OpenTelemetry 可开关；默认 no-op，无外部依赖。

增强版（需要集中化与可视化时启用）
- 指标采集：部署 Prometheus。
- 追踪：部署 Jaeger/Tempo，启用 OTLP 导出（gRPC/HTTP）。
- 日志集中：部署 Loki/ELK；服务仍输出到 stdout，由 Sidecar/Agent 收集。

配置开关（环境变量）
- `ENABLE_METRICS`、`ENABLE_TRACING`、`OTEL_EXPORTER_OTLP_ENDPOINT` 等。

示例（片段）
```python
# 结构化日志与指标中间件（示意）
from prometheus_client import Counter, Histogram, make_asgi_app
from starlette.middleware.base import BaseHTTPMiddleware

REQUESTS = Counter("http_requests_total", "Total HTTP requests", ["method", "path", "status"])
LATENCY = Histogram("http_request_duration_seconds", "Request latency", ["method", "path"])

class MetricsMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request, call_next):
        import time
        start = time.perf_counter()
        resp = await call_next(request)
        elapsed = time.perf_counter() - start
        REQUESTS.labels(request.method, request.url.path, str(resp.status_code)).inc()
        LATENCY.labels(request.method, request.url.path).observe(elapsed)
        return resp
```

---

## 9. TDD 与测试金字塔

测试策略
- 单元测试（Domain/Service）：占比 ~70%，不依赖数据库，Mock 仓储；覆盖软删除、审计落库、ltree 规则等。
- DB 集成测试（Infra/Repository）：占比 ~10%，验证 SQL/索引/ltree 查询；使用 Testcontainers 或 docker-compose 启临时 PG，运行 Alembic 迁移。
- API 集成测试（API 层）：占比 ~20%，使用 FastAPI `TestClient` 验证请求校验、错误体、分页、上下文注入等。

覆盖率门槛
- 总体 ≥80%，核心服务 ≥90%。PR 必须通过门槛与静态检查。

示例（片段）
```python
# tests/unit/test_document_service.py
from app.domain.services.documents import DocumentService

def test_create_document_records_audit_fields():
    class InMemoryDocRepo:
        def __init__(self):
            self.items = {}; self.next_id = 1
        def create(self, title, metadata, created_by):
            doc = {"id": self.next_id, "title": title, "metadata": metadata,
                   "created_by": created_by, "updated_by": created_by, "deleted_at": None}
            self.items[self.next_id] = doc; self.next_id += 1; return doc
    svc = DocumentService(InMemoryDocRepo())
    doc = svc.create(title="Spec A", metadata={"k": "v"}, user_id="u-1")
    assert doc["created_by"] == "u-1" and doc["deleted_at"] is None
```

---

## 10. 工程治理与 CI/CD

代码与质量
- 规范：`ruff`/`black`/`isort`/`mypy`；`pre-commit` 强制。
- 安全与合规：依赖漏洞扫描（pip-audit/Snyk）、SAST；生成 SBOM 并镜像签名。

CI/CD 流程
- PR：静态检查 + 单元/API 测试（快速）。
- 集成阶段：启动 PostgreSQL（Testcontainers/docker-compose），跑迁移与集成测试。
- 构建与发布：多阶段 Docker 构建，非 root 运行；部署前自动执行 Alembic 迁移与冒烟测试。

配置与密钥
- 12-Factor：配置通过环境变量；敏感信息不入仓库不进镜像；生产密钥由 Vault/KMS 管理。

运行与资源
- 健康检查、资源限额、HPA（如上 K8s），只读文件系统与最小权限。

---

## 11. 迭代计划（示例三段）

Sprint 1（MVP，1-1.5 周）
- 基础骨架（目录、依赖注入、错误映射）
- 文档/节点/关系 CRUD + 软删除 + ltree 子树查询
- `X-User-Id` 审计落库
- OpenAPI 文档基础 + 示例
- 结构化日志 + `/health` + `/ready` + `/metrics`
- Alembic 初始化与迁移（含 ltree）
- 单元/集成测试与 CI 基线；docker-compose 启动

### Sprint 1 任务清单（从环境到交付的全量事项）

1) 环境与工具准备
- 安装与校验：Python ≥ 3.11、pip/poetry、Docker Engine + compose plugin、git、openssl（`python --version`、`docker --version`、`docker compose version`）
- 全局工具：安装并启用 `pre-commit`（ruff/black/isort/mypy 钩子）
- 本地目录与权限：创建项目工作目录，确保 Docker 具备构建与网络权限（rootless 推荐）

2) 项目初始化与基础治理
- 代码骨架与目录：`api/app/domain/infra/common` 分层目录创建
- 依赖管理：生成 `pyproject.toml` 或 `requirements.txt`，锁定关键版本（FastAPI、SQLAlchemy 2.x、psycopg3、Alembic、pydantic v2、prometheus-client、pytest 等）
- 基础配置：`.editorconfig`、`.gitignore`、`pre-commit` 配置并安装钩子

3) 配置与脚本
- 环境变量：创建 `.env.development`（`DB_URL`、`ENABLE_METRICS=true`、`ENABLE_TRACING=false`、`API_KEY_ENABLED=false`）
- 启动脚本：`scripts/start.sh`（启动依赖、迁移、运行服务）与可选 `Makefile`（常用目标如 run/test/migrate）
- docker-compose：定义 `postgres` 服务（固定版本，如 16.x）、网络与卷；预留应用服务占位

4) 数据库与迁移
- 容器拉起：`docker compose up -d postgres`，健康检查通过
- Alembic 初始化：配置数据库连接（读取 `DB_URL`）并创建迁移仓库
- 初始迁移：启用 `ltree` 扩展；创建 `documents`、`nodes`、`node_documents` 表与索引（GIN/GIST、partial unique）
- 迁移执行与验证：`alembic upgrade head`，检查表与索引存在
- 种子数据：可选 `scripts/seed.py` 插入 `root` 节点与示例文档

5) 应用骨架与基础能力
- 应用主入口：`app/main.py`（FastAPI、中间件挂载、`/health`、`/ready`、`/metrics`）
- 观测中间件：结构化日志（JSON）与 Prometheus 指标（Counter/Histogram）
- 错误映射：统一异常到 RFC7807 响应体
- 依赖注入：数据库会话、请求上下文（`X-User-Id`）

6) 领域模型与仓储实现
- ORM 映射：`infra/db/models.py`（Documents/Nodes/NodeDocuments）
- 仓储接口与实现：`domain/repositories` 与 `infra/db/repositories.py`
- 领域服务：`DocumentService`、`NodeService`、`RelationshipService`（CRUD、软删除、ltree 子树查询、关系绑定/解绑）

7) API 路由与契约
- 路由：`api/v1/routers/documents.py|nodes.py|relationships.py`（`POST/GET/PUT/PATCH/DELETE` 与列表/子树）
- 一致性：分页/过滤（`include_deleted`）、审计头（`X-User-Id`）、错误体示例
- OpenAPI：自动生成并补充示例请求/响应/错误样例

8) 测试与质量保障（TDD）
- 单元测试：服务层为主，覆盖软删除、审计落库、ltree 规则；`pytest` 配置覆盖率门槛（总体 ≥80%，核心服务 ≥90%）
- API 集成测试：FastAPI `TestClient` 覆盖主要路径与错误体
- DB 集成测试：迁移后运行 ltree 子树查询验证（Testcontainers 或 docker-compose）
- 质量检查：ruff/black/isort/mypy 全绿

9) CI 流水线（快速 + 集成）
- 快速流水线：Lint/Type/Unit/API 测试
- 集成流水线：启动 PostgreSQL、执行迁移、运行集成测试；缓存 pip 与 Docker 层
- 构建步骤：构建应用镜像并产出 SBOM（可选），镜像签名（可选）

10) 容器与运行
- Dockerfile：多阶段构建、非 root 用户、只读文件系统（可配置）、健康检查
- docker-compose 应用服务：暴露端口（如 8000），依赖 `postgres`，启动命令与环境变量映射
- 一键启动：`scripts/start.sh` 或 `make run` 在本地起服务并自动迁移

11) 可观测性与运维基线
- 验证 `/metrics`、`/health`、`/ready` 可用；日志包含 `request_id`、`user_id`、`latency_ms`
- 指标检查：确认 `http_requests_total` 与时延直方图有数据
- 备份草案：记录 PostgreSQL 基础备份与迁移回滚方案（演练在测试环境）

12) 文档与示例
- README：环境要求、启动步骤、配置说明、常见问题
- API 文档：OpenAPI 链接与示例用法（curl/Postman）
- 变更日志：更新到 v3.0（Sprint 1 完成项）

13) 验收与交付
- Demo Script：按照验收场景依次执行（建树、挂文档、查询、软删与恢复）
- 验收清单：功能/非功能逐条勾选；覆盖率与质量门槛截图或报告链接
- 交付物打包：源码、容器镜像、docker-compose 文件、OpenAPI 文档、操作手册、变更日志

14) 风险控制与回滚
- 迁移回滚演练：`alembic downgrade -1` 可恢复；记录注意事项
- 数据一致性校验：软删除查询语义与唯一约束验证通过
- 性能冒烟：本地 200 RPS 冒烟压测，P95 读/写满足门槛（记录结果）


Sprint 2（安全与可观测增强，1 周）
- API Key 数据模型与校验中间件；内部管理 API（create/list/disable/enable/rotate）
- Prometheus 指标完善、基础 tracing（可开关）、请求 ID 中间件
- 错误体标准化（RFC7807）、分页/过滤/排序一致性
- 运维手册（备份策略草案：PITR/WAL-G）

Sprint 3（产品化与性能，1-1.5 周）
- 文档版本历史与回滚 API（全量快照起步）
- PostgreSQL 全文检索（`tsvector`），常用索引优化
- 限流（Redis 令牌桶）、写操作签名与防重放
- 异常与慢查询追踪、压测与优化报告

---

## 12. 风险与应对

- 树结构频繁变更导致性能波动：采用 `ltree`，移动仅更新路径与子树；事务保护与并发锁。
- API 变更影响上游兼容：严格版本化与弃用策略；提供兼容期与变更公告。
- 安全增强的过渡期：开发/测试环境放宽，生产通过网关与 TLS 加固；密钥轮换与应急预案到位。
- JSONB 膨胀与查询退化：区分冷热字段，建立 GIN 索引；应用层用 Pydantic v2 校验 JSON Schema。
- 数据备份与恢复：PITR（WAL-G）与演练；迁移回滚计划与变更评审。

---

## 13. 实施与交付清单（MVP 必交）

- 代码骨架与目录结构、依赖管理（requirements/pyproject）
- Alembic 初始迁移（启用 `ltree`、建表/索引/约束）
- 核心服务与仓储实现（Document/Node/Relationship）
- API 路由（含示例与错误体）、OpenAPI 文档
- 可观测性基础：日志/指标中间件、`/metrics`、`/health`、`/ready`
- 测试套件：单元 + API 集成 + （可选）DB 集成
- Dockerfile（多阶段、非 root）、docker-compose（服务 + PG）
- CI 模板：静态检查 + 测试 + 构建与迁移
- 运行与运维文档（配置、启动、迁移、备份草案）

---

## 14. 变更日志

v3.0（当前）
- 引入 `ltree` 作为树结构首选方案；数据模型与索引优化
- 规划安全渐进路线（API Key → HMAC 签名/限流 → OAuth2/mTLS）
- 可观测性零依赖基础与可插拔增强方案
- TDD 测试金字塔与覆盖率门槛，CI/CD 与容器安全
- 明确三阶段迭代计划与交付清单

v2.0（上一版）
- 初版架构与技术栈（FastAPI + PostgreSQL + SQLAlchemy + Alembic），MPTT 方案占位
- API 契约与审计思路、软删除与版本化规划

---

## 15. 结论

本方案以 MVP 为起点，保证“能用、可维护、可扩展”，并通过分层架构与渐进式安全/可观测策略，确保后续功能增强不会反噬架构。团队可以在现有 Python 技栈中稳健演进；若未来需要可切换到其他语言栈（如 NestJS/Go），当前边界与契约也为演进留出了空间。

如需我按本方案生成项目脚手架（代码/迁移/测试/CI/容器），请发起任务，我将分步交付。

---

## 附：按 Sprint 的可交付程序定义与验收标准

### 全局规范（适用于每个 Sprint）
- Definition of Ready（DoR）
  - 用户故事具备明确业务目标、输入/输出示例、异常情形与验收场景
  - API 变更已在 OpenAPI 草稿中体现，且完成评审
  - 数据模型/迁移设计已评审（含索引、约束、回滚方案）
  - 依赖已识别（第三方、运维资源、开关项）与可用性确认
- Definition of Done（DoD）基础门槛
  - 代码：通过 ruff/black/isort/mypy；无阻断级 Code Smell；关键路径具备注释
  - 测试：单元/集成/API 测试通过，总体覆盖率≥80%，核心服务≥90%
  - 文档：OpenAPI 同步更新，含请求/响应/错误示例；README/运行说明更新；变更日志更新
  - 可运行性：docker-compose 一键启动；/health、/ready、/metrics 可用
  - 安全与合规：不含明文密钥；容器非 root 运行；基本漏洞扫描通过
  - 迁移：Alembic 迁移可向前/回滚；在测试环境已演练
  - 可观测性：结构化日志输出；关键指标（QPS、时延直方图）暴露
- 验收方式
  - 演示脚本（Demo Script）：按场景操作与预期输出
  - 验收清单（Checklist）：功能+非功能逐条勾选
  - 回归影响：列出影响面并验证关键回归用例
- 质量门禁（CI Gate）
  - 所有检查通过才允许合并（Lint/Type/Test/SAST/依赖扫描）
  - 容器构建与 SBOM 生成，镜像签名；预发环境冒烟测试通过

### Sprint 1（MVP：资料与树的最小闭环）
1) Program Definition（本期范围）
- 功能范围
  - Documents：创建/查询/更新/删除（软删）
  - Nodes：创建/查询/更新/删除（软删）、基于 ltree 的子树查询
  - Node-Document 关联：创建/删除/按 node 或 document 列表
- 架构/数据
  - PostgreSQL + ltree 扩展启用；软删除策略与 partial unique index
  - 结构化日志 + /health + /ready + /metrics（零外部依赖）
- 安全
  - 开关式最简 API Key（或开发态可关闭），X-User-Id 审计落库
- API 契约
  - /api/v1 路由，分页/过滤基本一致性；RFC7807 错误体雏形
- 测试
  - TDD：Service 层单测优先；API 集成测试覆盖主要路径；DB 集成测试覆盖 ltree 子树查询

2) 交付物
- 可运行服务：docker-compose up 可运行（API、Postgres、迁移自动执行）
- OpenAPI 文档：含示例请求/响应/错误
- 基础运维文档：运行、迁移、备份草案、环境变量说明
- 自动化测试：CI 里可复现通过

3) 验收标准（可量化）
- 功能
  - 文档 CRUD：创建后可读、可更改、软删后默认列表不可见；提供 include_deleted 开关
  - 树查询：给定节点能返回子树；支持 depth 限制；根节点返回全树
  - 关联：一个节点可挂多文档；删除关联不影响文档与节点实体
- 非功能
  - 性能：在本机/测试环境 200 RPS 压测下，P95 响应时间 ≤ 150ms（读操作）；P95 ≤ 250ms（写）
  - 稳定：错误率 < 1%；数据库连接池配置合理，无连接泄漏
  - 观测：/metrics 暴露 http_requests_total 与时延直方图；日志含 request_id、user_id
- 质量门槛
  - 覆盖率 ≥ 80%；核心服务（Document/NodeService）≥ 90%
  - Lint/Type 检查全绿；容器以非 root 用户运行
- Demo 场景（节选）
  - 创建节点树 root、root.child；查询 root 子树应含两者
  - 创建文档并挂到 child；列表文档按 node_id 过滤可见
  - 软删除节点后默认列表不可见，include_deleted=true 时可见

### Sprint 2（安全与可观测性增强）
1) Program Definition
- 安全
  - API Key 模型：状态、过期时间、owner、last_used_at、scopes（初版）
  - 管理 API：create/list/disable/enable/rotate（internal）
- 可观测性
  - 指标完善：DB 连接池、错误分类；请求 ID 中间件；基础 tracing（可开关，无外部依赖时为 no-op）
- API 规范增强
  - 统一分页/排序/过滤约定；错误体标准化（RFC7807 完整）
- 文档/运维
  - 速率限制与签名方案的设计草案（不落地实现），迁移与备份策略细化

2) 交付物
- 可运行服务：启用/禁用 API Key 的配置开关；internal 管理端点默认受保护（仅内网/配置开关）
- OpenAPI 更新：含鉴权头示例、错误示例
- 指标与日志：新增指标/日志字段清单；追踪启停开关文档

3) 验收标准
- 功能
  - API Key 校验：无效/禁用/过期 Key 拒绝访问；有效 Key 正常访问
  - 管理 API：可创建、禁用、启用、轮换 Key，并在日志中记录操作人与操作结果
- 非功能
  - 性能影响：启用 Key 校验后，P95 额外开销 ≤ 10ms
  - 可观测性：错误率、DB 连接池、路由级别时延在 /metrics 可见；日志包含 api_key_id（或 client_id）
- 质量门槛
  - 管理 API 的权限校验覆盖测试 ≥ 90%；所有新增指标有简单阈值告警建议
- Demo 场景
  - 使用禁用 Key 访问失败；启用后成功
  - 轮换 Key：在宽限期内新旧 Key 均可用；宽限期结束仅新 Key 可用

### Sprint 3（产品化与性能）
1) Program Definition
- 版本与回滚
  - 文档版本历史（全量快照起步）：create_version、list_versions、rollback_to
- 检索
  - PostgreSQL FTS（tsvector）：按标题/元数据关键字搜索
- 性能与限流
  - Redis 令牌桶限流（按 API Key 维度）
  - 慢查询观测与索引优化

2) 交付物
- 版本历史数据模型与迁移、服务与 API
- FTS 索引与查询接口
- 限流中间件（可开关）与 Redis 配置说明
- 压测报告与优化记录（索引/SQL/连接池参数）

3) 验收标准
- 功能
  - 版本化：每次更新可生成版本；可按版本回滚；回滚后审计记录完整
  - 搜索：按标题/元数据关键词能检索到预期文档；支持分页/排序
  - 限流：达到配额时返回 429；重置后恢复
- 非功能
  - 性能：在 300 RPS 读为主、10% 写的负载下，P95 ≤ 180ms（读），P95 ≤ 280ms（写）；错误率 < 1%
  - 可靠性：回滚操作具备幂等性；出现失败时不会破坏现有数据一致性
- 质量门槛
  - 版本与回滚 API 覆盖率 ≥ 90%；FTS 查询与限流的集成测试完备
- Demo 场景
  - 更新文档两次，查看版本列表并回滚到第一个版本
  - 搭建小规模测试数据，执行关键词搜索并比对命中结果
  - 通过并发请求触发限流并观察指标与日志

### 通用验收清单（每个 Sprint 都需覆盖）
- 功能性：用户故事逐条演示，边界/异常路径覆盖
- API 契约：OpenAPI 与实现一致；示例可直接复制运行
- 数据与迁移：新增/变更表结构具备索引与约束；迁移可回滚且演练成功
- 安全：鉴权链路符合阶段目标；敏感信息不落盘不入库
- 可观测性：日志完整、指标齐全；/health、/ready 正常
- 测试与质量：覆盖率、静态检查、依赖扫描、容器安全全部通过
- 交付与可运行性：docker-compose 一键启动成功；环境变量样例与说明清晰；变更日志更新；已知限制与风险记录

### 落地方式建议
- 在项目根建立 `tests/acceptance` 目录，存放基于 Demo Script 的自动化验收测试（API 层），确保 CI 中自动验证
- 在 CI 中区分“快速流水线”（单元+API）与“集成流水线”（带 Postgres/Redis 的集成与压测）

---

## 附：每个 Sprint 的开发环境准备工作

### 通用准备（所有 Sprint 适用）
- 工具与运行时
  - Python ≥ 3.11、pip/poetry、Docker Engine + docker compose plugin
  - 代码质量工具：ruff、black、isort、mypy，预装并启用 `pre-commit`
  - 测试：pytest、pytest-cov；（可选）Testcontainers 以在测试阶段拉起临时 PostgreSQL/Redis
  - 压测工具（后续 Sprint 3 用）：k6 或 locust
- 本地环境配置
  - 创建 `.env.development`（样例：`DB_URL`、`ENABLE_METRICS=true`、`ENABLE_TRACING=false`、`API_KEY_ENABLED=false`）
  - 统一使用 Bash 脚本（`scripts/start.sh`）统一管理常用命令；可选提供 Makefile 封装常用目标
- 数据库与迁移
  - docker-compose 拉起 PostgreSQL（固定版本，如 16.x），首次运行执行 Alembic 迁移
  - 启用 `ltree` 扩展；准备基础数据的 seed 脚本
- 可观测性基础
  - 确认 `/metrics`、`/health`、`/ready` 可用；日志输出为结构化 JSON 到 stdout
- CI 资源
  - 配置 CI 缓存（pip 缓存、Docker 层缓存）；区分快速流水线与集成流水线

### Sprint 1（MVP：资料与树的最小闭环）
- 工具/依赖
  - 初始化 Python 依赖（FastAPI、SQLAlchemy 2.x、psycopg3、Alembic、pydantic v2、prometheus-client、pytest 等）
  - 安装并启用 `pre-commit` 钩子（ruff/black/isort/mypy）
- 配置
  - `.env.development`：关闭 API Key（`API_KEY_ENABLED=false`），开启指标（`ENABLE_METRICS=true`）
  - `docker-compose.yml`：包含 `web` 与 `postgres` 服务；映射 5432 与应用端口（如 8000）
- 数据库
  - 执行 Alembic 初始迁移：建表、索引，启用 `ltree`
  - 准备最小 seed 数据（如 `root` 节点）
- 测试与验收
  - 跑单元/API 测试；确保覆盖率达到门槛
  - 准备 `tests/acceptance` 的基础验收用例（CRUD、子树查询）并在本地与 CI 运行
- 可观测性
  - 验证日志与 `/metrics` 暴露；确认 `http_requests_total` 和时延直方图生效

### Sprint 2（安全与可观测性增强）
- 工具/依赖
  - 引入安全相关依赖（若需要哈希/签名库，如 `python-jose` 或 `cryptography`，具体视实现而定）
- 配置
  - `.env.development`：启用基础 API Key（`API_KEY_ENABLED=true`），设置示例 Key；保留开关以便联调
  - 管理端点保护：通过网络层（仅本地）或环境开关限制访问
  - 观测开关：预置 `ENABLE_TRACING=false`；后续可开启并指向 OTLP 端点
- 数据库
  - 迁移新增 `api_keys` 表（含状态、过期、owner、scopes 等字段）
  - 准备管理 API 的演示数据（创建/禁用/启用/轮换）
- 测试与验收
  - 增加 API Key 校验与管理 API 的单元/集成测试；更新 `tests/acceptance` 验收脚本
  - 在 CI 集成流水线中拉起 PostgreSQL，跑迁移与相关测试
- 可观测性
  - 扩充指标（错误分类、DB 连接池）；添加请求 ID 中间件；保留 tracing 的开关（默认 no-op）

### Sprint 3（产品化与性能）
- 工具/依赖
  - 引入 Redis 客户端（`redis-py`）；（可选）压测工具 k6/locust 的脚本仓库或配置
- 配置
  - `.env.development`：配置 Redis 连接（`REDIS_URL`），启用限流开关（`RATE_LIMIT_ENABLED=true`）
  - `docker-compose.yml`：新增 `redis` 服务，绑定默认端口 6379
- 数据库
  - 为全文检索建立 `tsvector` 索引（迁移脚本）；为版本历史新增表结构（全量快照起步）
- 测试与验收
  - 增加版本与回滚、FTS 搜索、限流的集成与验收测试；准备压测脚本与数据集
  - 在 CI 集成流水线中拉起 PostgreSQL 与 Redis，执行相关测试与简易压测（如冒烟级）
- 可观测性与性能
  - 开启慢查询日志（PostgreSQL 配置或应用层统计）；收集性能指标并输出小型优化报告
  - 根据压测结果调整索引、SQL 与连接池参数

### 额外说明（跨平台/Windows）
- 统一使用 Bash 脚本与 Makefile（可选），不提供 PowerShell
- Linux 开发环境要求：Docker Engine（rootless 推荐）、compose plugin、openssl、git；确保内核参数与资源限制（ulimit）符合容器建议

