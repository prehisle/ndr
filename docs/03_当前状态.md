# 通用资料管理微服务当前状态评估

## 已实现
- 文档、节点、关系的核心 CRUD、软删除与分页能力均已上线，基本契合 MVP 的 API 范围要求（`app/api/v1/routers/documents.py:16`、`app/api/v1/routers/nodes.py:17`、`app/api/v1/routers/relationships.py:14`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:42`）。
- 请求上下文可读取 `X-User-Id`/`X-Request-Id` 并写入审计字段，同时保留可选的 API Key 校验，与方案中的审计最小闭环保持一致（`app/api/v1/deps.py:7`、`app/api/v1/routers/documents.py:17`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:47`）。
- 节点模型已引入方言感知的 `ltree` 列类型、`parent_path` 字段以及路径/同级名称的部分唯一索引，配合路由层的冲突校验，落地树结构的数据约束（`app/infra/db/models.py:24`、`app/infra/db/types.py:1`、`app/api/v1/routers/nodes.py:17`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:77`）。
- 配置层默认并强制使用 PostgreSQL，启动时自动执行 Alembic 迁移，pytest 通过会话级迁移与用例级清理确保在真实 PG 上运行（`app/common/config.py:40`、`app/infra/db/session.py:7`、`app/infra/db/alembic_support.py:1`、`tests/conftest.py:1`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:58`）。
- 指标中间件、`/metrics`、`/health`、`/ready` 及低基数标签的 Prometheus 统计已实现，并统一生成 `X-Request-Id`，覆盖可观测性基础目标（`app/main.py:25`、`app/infra/observability/metrics.py:3`、`app/infra/observability/middleware.py:21`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:52`）。
- 异常处理输出 RFC 7807 兼容的 problem+json 响应体，满足接口错误契约的一致性要求（`app/main.py:60`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:92`）。
- 写请求支持 `Idempotency-Key`，重复提交可复用已存响应，不一致载荷触发 409 冲突，满足“最小幂等”要求（`app/common/idempotency.py:9`、`app/api/v1/routers/documents.py:17`、`tests/test_api_crud.py:7`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:50`）。
- 建立 Alembic 工程骨架与首个迁移脚本，启用 `ltree` 扩展并创建约束/索引，新增 `/ready` 对迁移版本与扩展的校验（`alembic/env.py:1`、`alembic/versions/20241017_0001_initial_schema.py:1`、`app/main.py:94`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:58`、`docs/02_技术规划与实施方案 v4.0.md:55`）。
- `/nodes/{id}/children` 子树查询已全面改为 PostgreSQL `ltree` 运算符 `<@` + 深度限制，移除字符串前缀匹配兜底（`app/api/v1/routers/nodes.py`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:40`）。
- 节点更新支持 slug 与父节点移动，使用事务 + `pg_advisory_xact_lock` 并重写子树路径，实现规划中的“简单移动+并发控制”（`app/api/v1/routers/nodes.py`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:26`）。
- Problem+JSON 响应补齐稳定的 `error_code` 字段，默认对常见状态码（404、409、422 等）产出一致的错误代码（`app/main.py:27`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:94`）。
- 引入 GitHub Actions 工作流，自动执行 pre-commit 检查与 PostgreSQL 驱动的 Pytest 测试，覆盖质量基线（`.github/workflows/ci.yml:1`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:120`）。
- 提供 `scripts/benchmark_ltree.py` 工具，可在 PostgreSQL 上对 GIST / GIN 索引进行子树查询基准测试（需启用 `ltree`、`btree_gist`、`btree_gin` 扩展；若当前版本缺少 GIN 运算符类，脚本会自动跳过并提示仅运行 GIST）（`scripts/benchmark_ltree.py:1`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:24`）。

## 部分实现
- 路由层直接操作 ORM 会话，尚未抽离方案中预期的 `api → app → domain` 分层与服务接口（`app/api/v1/routers/documents.py:16`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:65`）。
- 已补充 ltree 数据库集成测试（`tests/test_db_ltree.py:1`），但领域/服务层单元测试仍未覆盖，测试金字塔尚待完善（规划参照 `docs/02_技术规划与实施方案 v4.0.md:115`）。

## 尚缺
- CI 仍需拓展慢流水线（数据库压测、容器安全扫描等）与变更通知，当前工作流仅覆盖 lint/单元/API 测试（规划参照 `docs/02_技术规划与实施方案 v4.0.md:120`）。
- `ltree` 索引压测目前仅覆盖 GIST；由于现阶段运行环境缺少 `ltree_gin` 运算符类，GIN 对比基线已暂时无限期延后，待后续具备条件再恢复规划（规划参照 `docs/02_技术规划与实施方案 v4.0.md:24`、`docs/02_技术规划与实施方案 v4.0.md:78`）。
- 节点/关系查询仍散落在路由函数中，缺少 `app`/`domain` 层的复用能力；需要抽象 `NodeService` 等服务（含 `get_subtree_documents` 等方法）并补充领域单元测试，以支撑节点子树批量查询等需求。

## 建议后续步骤
1. 拉通慢流水线：补充数据库压测、容器安全、制品扫描等阶段化 CI 任务。
2. 在现有环境先聚焦 GIST 指标；待具备 `ltree_gin` 扩展后再恢复 GIN 对比与子树移动的联合压测，沉淀针对不同索引策略的调优建议。
3. 拆分 `api → app → domain` 分层并补齐领域/仓储单元测试，逐步提升测试金字塔覆盖深度。
