# 通用资料管理微服务当前状态评估

## 已实现
- 文档、节点、关系的核心 CRUD、软删除与分页能力均已上线，基本契合 MVP 的 API 范围要求（`app/api/v1/routers/documents.py:16`、`app/api/v1/routers/nodes.py:17`、`app/api/v1/routers/relationships.py:14`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:42`）。
- 请求上下文可读取 `X-User-Id`/`X-Request-Id` 并写入审计字段，同时保留可选的 API Key 校验，与方案中的审计最小闭环保持一致（`app/api/v1/deps.py:7`、`app/api/v1/routers/documents.py:17`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:47`）。
- 节点模型已引入方言感知的 `ltree` 列类型、`parent_path` 字段以及路径/同级名称的部分唯一索引，配合路由层的冲突校验，落地树结构的数据约束（`app/infra/db/models.py:24`、`app/infra/db/types.py:1`、`app/api/v1/routers/nodes.py:17`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:77`）。
- 配置层默认并强制使用 PostgreSQL，启动时自动执行 Alembic 迁移，pytest 通过会话级迁移与用例级清理确保在真实 PG 上运行（`app/common/config.py:40`、`app/infra/db/session.py:7`、`app/infra/db/alembic_support.py:1`、`tests/conftest.py:1`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:58`）。
- 指标中间件、`/metrics`、`/health`、`/ready` 及低基数标签的 Prometheus 统计已实现，并统一生成 `X-Request-Id`，覆盖可观测性基础目标（`app/main.py:25`、`app/infra/observability/metrics.py:3`、`app/infra/observability/middleware.py:21`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:52`）。
- 异常处理输出 RFC 7807 兼容的 problem+json 响应体，满足接口错误契约的一致性要求（`app/main.py:60`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:92`）。
- 写请求支持 `Idempotency-Key`，重复提交可复用已存响应，不一致载荷触发 409 冲突，满足“最小幂等”要求（`app/common/idempotency.py:9`、`app/api/v1/routers/documents.py:17`、`tests/test_api_crud.py:7`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:50`）。
- 建立 Alembic 工程骨架与首个迁移脚本，启用 `ltree` 扩展并创建约束/索引，新增 `/ready` 对迁移版本与扩展的校验（`alembic/env.py:1`、`alembic/versions/20241017_0001_initial_schema.py:1`、`app/main.py:94`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:58`、`docs/02_技术规划与实施方案 v4.0.md:55`）。

## 部分实现
- 树结构虽已具备 `ltree` 类型与约束，但子树查询仍使用字符串匹配，占位的节点移动逻辑尚未支持批量更新/并发锁（`app/api/v1/routers/nodes.py:206`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:77`、`docs/02_技术规划与实施方案 v4.0.md:43`）。
- 路由层直接操作 ORM 会话，尚未抽离方案中预期的 `api → app → domain` 分层与服务接口（`app/api/v1/routers/documents.py:16`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:65`）。
- 测试集主要覆盖 API 顺畅路径，尚未补充领域/服务层单元测试及 `ltree` 相关的数据库集成测试，未达成规划中的测试金字塔目标（`tests/test_api_crud.py:7`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:115`）。

## 尚缺
- CI / 本地工作流需补充启动 PostgreSQL 容器或云服务的标准化脚本（如 `docker-compose`）、以及流水线中对 `alembic upgrade head` 的执行，当前仅在应用启动和测试夹具中自动化完成（规划参照 `docs/02_技术规划与实施方案 v4.0.md:61`）。
- 缺少节点移动批量更新、`ltree` 子树查询的 GIST/GN 索引压测验证，以及并发控制（`app/api/v1/routers/nodes.py:206`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:78`）。
- 仓库中尚未落地 `docker-compose`、`pre-commit`、CI 配置等工程化资产，与基线建设计划存在缺口（规划参照 `docs/02_技术规划与实施方案 v4.0.md:57`、`docs/02_技术规划与实施方案 v4.0.md:61`）。

## 建议后续步骤
1. 引入可复用的 PostgreSQL 本地/CI 环境（如 `docker-compose`），并在流水线中显式执行 `alembic upgrade head` 与冒烟测试，巩固“仅用 PG”规范。
2. 完善节点子树查询与移动能力：使用 `ltree` 运算符替换字符串匹配，补齐节点移动时对子树路径的批量更新及锁策略。
3. 拆分服务/领域层并完善测试金字塔，补齐 domain/service 单元测试与数据库集成测试，同时引入 `pre-commit`/CI 脚本支撑质量门槛。
