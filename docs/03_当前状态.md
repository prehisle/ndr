# 通用资料管理微服务当前状态评估

## 已实现
- 文档、节点、关系的核心 CRUD、软删除与分页能力均已上线，基本契合 MVP 的 API 范围要求（`app/api/v1/routers/documents.py:16`、`app/api/v1/routers/nodes.py:17`、`app/api/v1/routers/relationships.py:14`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:42`）。
- 请求上下文可读取 `X-User-Id`/`X-Request-Id` 并写入审计字段，同时保留可选的 API Key 校验，与方案中的审计最小闭环保持一致（`app/api/v1/deps.py:7`、`app/api/v1/routers/documents.py:17`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:47`）。
- 节点模型已引入方言感知的 `ltree` 列类型、`parent_path` 字段以及路径/同级名称的部分唯一索引，配合路由层的冲突校验，落地树结构的数据约束（`app/infra/db/models.py:24`、`app/infra/db/types.py:1`、`app/api/v1/routers/nodes.py:17`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:77`）。
- 配置层默认并强制使用 PostgreSQL，启动时自动执行 Alembic 迁移，pytest 通过会话级迁移与用例级清理确保在真实 PG 上运行（`app/common/config.py:40`、`app/infra/db/session.py:7`、`app/infra/db/alembic_support.py:1`、`tests/conftest.py:1`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:58`）。
- 指标中间件、`/metrics`、`/health`、`/ready` 及低基数标签的 Prometheus 统计已实现，并统一生成 `X-Request-Id`，覆盖可观测性基础目标（`app/main.py:25`、`app/infra/observability/metrics.py:3`、`app/infra/observability/middleware.py:21`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:52`）。
- 异常处理输出 RFC 7807 兼容的 problem+json 响应体，满足接口错误契约的一致性要求（`app/main.py:60`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:92`）。
- 写请求支持 `Idempotency-Key`，重复提交可复用已存响应，不一致载荷触发 409 冲突，满足“最小幂等”要求（`app/common/idempotency.py:9`、`app/api/v1/routers/documents.py:17`、`tests/test_api_crud.py:7`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:50`）。
- 建立 Alembic 工程骨架与首个迁移脚本，启用 `ltree` 扩展并创建约束/索引，新增 `/ready` 对迁移版本与扩展的校验（`alembic/env.py:1`、`alembic/versions/20241017_0001_initial_schema.py:1`、`app/main.py:94`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:58`、`docs/02_技术规划与实施方案 v4.0.md:55`）。
- `/nodes/{id}/children` 子树查询已全面改为 PostgreSQL `ltree` 运算符 `<@` + 深度限制，移除字符串前缀匹配兜底（`app/api/v1/routers/nodes.py`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:40`）。
- 节点更新支持 slug 与父节点移动，使用事务 + `pg_advisory_xact_lock` 并重写子树路径，实现规划中的“简单移动+并发控制”（`app/api/v1/routers/nodes.py`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:26`）。

## 部分实现
- 路由层直接操作 ORM 会话，尚未抽离方案中预期的 `api → app → domain` 分层与服务接口（`app/api/v1/routers/documents.py:16`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:65`）。
- 测试集主要覆盖 API 顺畅路径，尚未补充领域/服务层单元测试及 `ltree` 相关的数据库集成测试，未达成规划中的测试金字塔目标（`tests/test_api_crud.py:7`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:115`）。

## 尚缺
- CI / 本地工作流仍缺少自动化流水线与 `pre-commit` 规范化配置，`docker-compose` 已补齐但质量门槛脚本尚未整合到 CI（规划参照 `docs/02_技术规划与实施方案 v4.0.md:57`、`docs/02_技术规划与实施方案 v4.0.md:61`）。
- `ltree` 索引（GIST vs GIN）与子树移动的压测验证尚未开展，无法确认最佳索引策略和性能基线（规划参照 `docs/02_技术规划与实施方案 v4.0.md:24`、`docs/02_技术规划与实施方案 v4.0.md:78`）。
- Problem+JSON 仍缺少稳定的 `error_code` 字段，需按规划补齐错误契约细化（`app/main.py:57`；规划参照 `docs/02_技术规划与实施方案 v4.0.md:94`）。

## 建议后续步骤
1. 引入 `pre-commit`、CI 流水线与标准化脚本，确保 `alembic upgrade head`、lint、测试在自动化流程中执行。
2. 开展 `ltree` 索引与子树移动的基准测试，沉淀针对 GIST/GIN 的指标报告与调优建议。
3. 拆分 `api → app → domain` 分层并补齐领域/仓储单元测试，同时扩展 Problem+JSON 错误体以输出稳定的 `error_code`。
