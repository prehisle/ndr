# 通用资料管理微服务当前状态评估

## 已实现
- 文档、节点、关系的核心 CRUD、软删除与分页能力均已上线，基本契合 MVP 的 API 范围要求（`app/api/v1/routers/documents.py:16`、`app/api/v1/routers/nodes.py:16`、`app/api/v1/routers/relationships.py:14`；规划参照 `docs/技术规划与实施方案 v4.0.md:42`）。
- 请求上下文可读取 `X-User-Id`/`X-Request-Id` 并写入审计字段，同时保留可选的 API Key 校验，与方案中的审计最小闭环保持一致（`app/api/v1/deps.py:18`、`app/api/v1/routers/documents.py:17`；规划参照 `docs/技术规划与实施方案 v4.0.md:47`）。
- 指标中间件、`/metrics`、`/health`、`/ready` 及低基数标签的 Prometheus 统计已实现，并统一生成 `X-Request-Id`，覆盖可观测性基础目标（`app/main.py:46`、`app/infra/observability/metrics.py:3`、`app/infra/observability/middleware.py:21`；规划参照 `docs/技术规划与实施方案 v4.0.md:52`）。
- 异常处理输出 RFC 7807 兼容的 problem+json 响应体，满足接口错误契约的一致性要求（`app/main.py:56`；规划参照 `docs/技术规划与实施方案 v4.0.md:92`）。
- 写请求支持 `Idempotency-Key`，重复提交可复用已存响应，不一致载荷触发 409 冲突，满足“最小幂等”要求（`app/common/idempotency.py:9`、`app/api/v1/routers/documents.py:16`、`tests/test_api_crud.py:86`；规划参照 `docs/技术规划与实施方案 v4.0.md:50`）。
- 结构化日志补充 `user_id`，`/ready` 增强为检测核心数据表是否存在，提升可观测性与运维自检能力（`app/infra/observability/middleware.py:21`、`app/main.py:90`；规划参照 `docs/技术规划与实施方案 v4.0.md:53`、`docs/技术规划与实施方案 v4.0.md:55`）。

## 部分实现
- 树结构仍以字符串前缀模拟 `ltree`，缺少 PostgreSQL 扩展与索引的能力，也未覆盖节点移动的并发安全策略（`app/infra/db/models.py:28`、`app/api/v1/routers/nodes.py:112`；规划参照 `docs/技术规划与实施方案 v4.0.md:77`）。
- 路由层直接操作 ORM 会话，尚未抽离方案中预期的 `api → app → domain` 分层与服务接口（`app/api/v1/routers/documents.py:16`；规划参照 `docs/技术规划与实施方案 v4.0.md:65`）。
- 关系表缺少软删除与审计列，难以满足统一的数据治理要求（`app/infra/db/models.py:35`；规划参照 `docs/技术规划与实施方案 v4.0.md:83`）。
- 测试集主要覆盖 API 顺畅路径，尚未补充领域/服务层单元测试及 `ltree` 相关的数据库集成测试，未达成规划中的测试金字塔目标（`tests/test_api_crud.py:7`；规划参照 `docs/技术规划与实施方案 v4.0.md:115`）。

## 尚缺
- 缺乏 Alembic 迁移、PostgreSQL 连接与 `ltree` 扩展启用，配置仍指向 SQLite 并依赖 `Base.metadata.create_all`，偏离迁移优先的工程基线（`app/common/config.py:6`、`app/main.py:51`；规划参照 `docs/技术规划与实施方案 v4.0.md:58`、`docs/技术规划与实施方案 v4.0.md:79`）。
- 数据模型中缺少对 `slug/path` 与同级 `name` 的部分唯一索引，无法保障路径/命名规则的强一致性（`app/infra/db/models.py:25`；规划参照 `docs/技术规划与实施方案 v4.0.md:82`）。
- 仓库中尚未落地 `docker-compose`、`pre-commit`、CI 配置等工程化资产，与基线建设计划存在缺口（规划参照 `docs/技术规划与实施方案 v4.0.md:57`、`docs/技术规划与实施方案 v4.0.md:61`）。

## 建议后续步骤
1. 切换到 PostgreSQL + Alembic 迁移链路，启用 `ltree` 并补齐索引、软删除约束，同时让 `/ready` 校验迁移版本、连接池可用性。
2. 实现节点移动并发控制、关系表审计/软删除以及部分唯一索引，确保树结构与数据约束符合规划。
3. 拆分服务/领域层并完善单元与数据库集成测试，配套交付 `docker-compose`、`pre-commit` 与 CI 脚本，建立持续交付基线。
